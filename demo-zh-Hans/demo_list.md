## Thor 的使用技巧

### -1、参加 TestFlight 公测

TF 会在有个重大功能更新时放出，参加途径参照『Thor > 更多 > 把 Thor 推荐给朋友』功能。
已经申请过公测的同学，不用再重复申请。


### 0、HTTPS 解析配置

#### 证书信任问题

`Thor SSL CA 证书` 需要『安装』到手机系统并且『信任』才能正常解析 HTTPS 流量。

证书安全问题：每份 Thor 证书都是即时随机生成（Thor 用户间彼此不同），不上传服务器，只存放在设备本地，Thor 只是把`证书手动随机生成`自动化了。


#### HTTPS 解析原理

Thor 实现的 HTTPS 解析方式是 MITM （中间人欺骗）：需要用 Thor SSL CA 根证书针对特定域名生成叶子证书，用此叶子证书跟客户端（请求发起方）通信，并成功解析流量。

客户端（请求发起方）如果做了证书本地验证（即验证跟它通信的叶子证书是否是它原来商定好的证书），那么 Thor 生成的叶子证书跟客户端之间的 SSL 连接将会失败，自然就也解不了这类流量。

总之 HTTPS MITM 不是万能的，望知晓。

[HTTPS MITM 解析失败的示例](touch https_mitm_fail.md)


### 1、关于抓到的数据在哪查看，以及怎么保存的问题

所有成功抓包的数据都在： `包详情 -> 响应 -> 消息体` 中，消息体查看界面的`『分享』`入口可以保存或者导出。

[点我看示例](how_to_save_data/how_to_save_data.md)


### 2、音频、视频 206 或者 302 响应状态码出现的不能播放问题

*响应状态码* 是请求本身决定的，`Thor` 只是**忠实**地记录下此过程。

| 状态码 | 含义说明 |
|:-------------|:-------------|
| 200 | 可以正常播放的音视频，常见于网页直接播放或者下载 |
| 206 | 完整音视频被拆成了很多段，每个 206 都是其中的一段，且不能直接播放（首段除外），常见于播放器播放产生 |
| 301 或 302 | 请求的音视频 url 地址变更为其它 url，新的 url 在 `包详情 -> 响应 -> 请求头 -> Location` 中可以找到 |
| 304 | 向服务器询问 url 指向的资源是否有更新，无更新则服务器返回 304。所以不会有资源被抓到，但是请求的 url 可以单独去下载的 |


### 3、Thor 过滤器，筛选器的作用原理

* 过滤器
	* **抓包过滤**（`关键字`、`域名`、`方法等`）：抓包开始前设置，用于过滤『哪些包你能抓到』。过滤规则只在包的『请求行』，『请求头』中匹配。
	* **按需启动域名**：配置自动触发抓包的域名，当设备中任何地方访问该域名时，会自动启动抓包。
	* **DNS 服务器**：配置抓包可能会用到的自定义 DNS 地址，比如 8.8.8.8 之类的，大家懂的。


* 筛选器

对已经抓到的包筛选，筛选条件在包的『请求』和『响应』全部信息中匹配。


### 4、抓包的套路（图森破）

* 暗中观察：先用『全局（默认）』过滤器抓取目标链接，找到相应的包，观察包的『请求』和『响应』信息。

* 仔细推敲：从包的『请求』和『响应』信息中找到蛛丝马迹，得到过滤条件。

* 创建过滤器：用研究得到的过滤条件，创建过滤器，实现定向抓包。

* 配合插件：用通知栏『Thor HTTP 抓包』插件 或者 iPad 分屏抓包进行实时监控、分析，效果更佳哦。

* URL Scheme：配合 workflow 等三方工具使用，可以达到*啧啧称奇*的自动化效果。


### 5、参考教程

* [新浪微博 APP GIF 图片抓取](iOS_Thor_GIF_weibo/iOS_Thor_GIF_weibo.md)

* [抓取秒拍视频](http://v.youku.com/v_show/id_XMjY1OTM3MTQ0NA==.html?f=49309652&spm=a2hzp.8244740.userfeed.5!2~5~5~5!3~5~A)